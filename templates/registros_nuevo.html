{% extends "layout.html" %}
{% block content %}
{% set is_edit = is_edit or False %}
<div class="card">
  <h2>{{ 'Editar registro' if is_edit else 'Nuevo registro' }}</h2>

  <!-- IMPORTANTÍSIMO: enctype para poder enviar archivos -->
  <form method="post"
        action="{{ url_for('registros.actualizar', registro_id=registro.id) if is_edit else url_for('registros.crear') }}"
        enctype="multipart/form-data"
        class="stack">
    <section class="stack">
      <div class="row">
        <div class="field">
          <label>Cliente único</label>
          <input id="cliente_unico"
                 name="cliente_unico"
                 list="dl_cu"
                 autocomplete="off"
                 placeholder="Buscar..."
                 value="{{ registro.cliente_unico if is_edit else '' }}"
                 required>
          <datalist id="dl_cu"></datalist>
          <p class="help">Escribe al menos dos caracteres para ver sugerencias.</p>
        </div>
        <div class="field">
          <label>Nombre</label>
          <input id="nombre_cte" type="text" value="{{ registro.nombre_cte_snap if is_edit else '' }}" readonly>
        </div>
        <div class="field">
          <label>Gerencia</label>
          <input id="gerencia" type="text" value="{{ registro.gerencia_snap if is_edit else '' }}" readonly>
        </div>
        <div class="field">
          <label>Producto</label>
          <input id="producto" type="text" value="{{ registro.producto_snap if is_edit else '' }}" readonly>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>FIDIAPAGO</label>
          <input id="fidiapago" type="text" value="{{ registro.fidiapago_snap if is_edit else '' }}" readonly>
        </div>
      </div>

      <div class="field">
        <label>GESTION_DESC</label>
        <textarea id="gestion_desc" rows="5" readonly>{{ registro.gestion_desc_snap if is_edit else '' }}</textarea>
      </div>
    </section>

    <hr>

    <section class="stack">
      <div class="row">
        <div class="field">
          <label>Tipo de convenio</label>
          <select name="tipo_convenio_id" required>
            {% for t in tipos %}
            <option value="{{ t.id }}" {% if is_edit and registro.tipo_convenio_id == t.id %}selected{% endif %}>{{ t.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="field">
          <label>Boca de cobranza</label>
          <select name="boca_cobranza_id" required>
            {% for b in bocas %}
            <option value="{{ b.id }}" {% if is_edit and registro.boca_cobranza_id == b.id %}selected{% endif %}>{{ b.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="field">
          <label>Fecha promesa</label>
          <input type="date" name="fecha_promesa" value="{{ registro.fecha_promesa.isoformat() if is_edit and registro.fecha_promesa else '' }}">
        </div>
        <div class="field">
          <label>Teléfono</label>
          <input type="text" name="telefono" placeholder="10 dígitos" value="{{ registro.telefono if is_edit and registro.telefono else '' }}">
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Pago inicial</label>
          <input type="text"
                 name="pago_inicial"
                 class="currency"
                 data-currency
                 placeholder="$0.00"
                 value="{{ '$ {:,.2f}'.format(registro.pago_inicial) if is_edit and registro.pago_inicial is not none else '' }}">
          <p class="help">Ingresa el monto acordado al momento de la promesa.</p>
        </div>
        <div class="field">
          <label>Pago semanal</label>
          <input type="text"
                 name="pago_semanal"
                 class="currency"
                 data-currency
                 placeholder="$0.00"
                 value="{{ '$ {:,.2f}'.format(registro.pago_semanal) if is_edit and registro.pago_semanal is not none else '' }}">
        </div>
        <div class="field">
          <label>Duración (semanas)</label>
          <input type="number" name="duracion_semanas" min="1" max="120" placeholder="0" value="{{ registro.duracion_semanas if is_edit and registro.duracion_semanas else '' }}">
        </div>
        <div class="field">
          <label>Semana (1-52)</label>
          <input type="number" name="semana" min="1" max="52" placeholder="Ej. 24" value="{{ registro.semana if is_edit and registro.semana else '' }}">
        </div>
      </div>

      <div class="field">
        <label>Notas</label>
        <textarea name="notas" rows="4" placeholder="Observaciones relevantes">{{ registro.notas if is_edit and registro.notas else '' }}</textarea>
      </div>
    </section>

    <!-- ===== Evidencias (PDF/JPG/PNG) ===== -->
    <section class="stack">
      <hr>
      <div class="row tight">
        <div class="field">
          <label>Convenio (PDF/imagen)</label>
          {% if is_edit and registro.archivo_convenio %}
          <div class="current-file">
            <a href="{{ url_for('registros.get_file', fname=registro.archivo_convenio) }}" target="_blank">Ver archivo actual</a>
            <label class="checkbox-inline"><input type="checkbox" name="eliminar_archivo_convenio" value="1"> Eliminar</label>
          </div>
          <p class="help">Sube un archivo nuevo para reemplazar o marca eliminar.</p>
          {% endif %}
          <input type="file" name="archivo_convenio" accept=".pdf,.png,.jpg,.jpeg">
        </div>
        <div class="field">
          <label>Ticket/Pago (PDF/imagen)</label>
          {% if is_edit and registro.archivo_pago %}
          <div class="current-file">
            <a href="{{ url_for('registros.get_file', fname=registro.archivo_pago) }}" target="_blank">Ver archivo actual</a>
            <label class="checkbox-inline"><input type="checkbox" name="eliminar_archivo_pago" value="1"> Eliminar</label>
          </div>
          <p class="help">Sube un archivo nuevo para reemplazar o marca eliminar.</p>
          {% endif %}
          <input type="file" name="archivo_pago" accept=".pdf,.png,.jpg,.jpeg">
        </div>
        <div class="field">
          <label>Evidencia de gestión (PDF/imagen)</label>
          {% if is_edit and registro.archivo_gestion %}
          <div class="current-file">
            <a href="{{ url_for('registros.get_file', fname=registro.archivo_gestion) }}" target="_blank">Ver archivo actual</a>
            <label class="checkbox-inline"><input type="checkbox" name="eliminar_archivo_gestion" value="1"> Eliminar</label>
          </div>
          <p class="help">Sube un archivo nuevo para reemplazar o marca eliminar.</p>
          {% endif %}
          <input type="file" name="archivo_gestion" accept=".pdf,.png,.jpg,.jpeg">
        </div>
      </div>
    </section>

    <div class="actions">
      <button type="submit">{{ 'Actualizar' if is_edit else 'Guardar' }}</button>
      <a class="btn secondary" href="{{ url_for('registros.listado') }}">Cancelar</a>
    </div>
  </form>
</div>

<script>
  const $cu   = document.getElementById('cliente_unico');
  const $dl   = document.getElementById('dl_cu');
  const $nom  = document.getElementById('nombre_cte');
  const $ger  = document.getElementById('gerencia');
  const $prod = document.getElementById('producto');
  const $fidi = document.getElementById('fidiapago');
  const $gest = document.getElementById('gestion_desc');

  // 1) Autocomplete con datalist
  let lastQ = "";
  $cu.addEventListener('input', async () => {
    const q = $cu.value.trim();
    if (q.length < 2 || q === lastQ) return;
    lastQ = q;
    try {
      const r = await fetch(`/registros/api/search_cliente?term=${encodeURIComponent(q)}`);
      if (!r.ok) return;
      const data = await r.json();
      $dl.innerHTML = '';
      data.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.cliente_unico;
        opt.label = item.nombre_cte || '';
        $dl.appendChild(opt);
      });
    } catch (e) { /* noop */ }
  });

  // 2) Autollenar al elegir un valor del datalist (o al perder foco)
  async function fillCliente() {
    const cu = $cu.value.trim();
    if (!cu) return;
    try {
      const r = await fetch(`/registros/api/datos_cliente?cu=${encodeURIComponent(cu)}`);
      const j = await r.json();
      if (!j.ok) {
        $nom.value = $ger.value = $prod.value = $fidi.value = '';
        $gest.value = '';
        return;
      }
      $nom.value  = j.data.nombre_cte || '';
      $ger.value  = j.data.gerencia || '';
      $prod.value = j.data.producto || '';
      $fidi.value = j.data.fidiapago || '';
      $gest.value = j.data.gestion_desc || '';
    } catch (e) { /* noop */ }
  }

  $cu.addEventListener('change', fillCliente);
  $cu.addEventListener('blur', fillCliente);

  // 3) Formato de moneda MXN en los campos con data-currency
  const currencyInputs = document.querySelectorAll('[data-currency]');
  const formatter = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', minimumFractionDigits: 2 });

  const parseCurrency = (value) => {
    if (!value) return '';
    let cleaned = value.replace(/[^0-9.,-]/g, '').replace(/\u00a0/g, '').trim();
    if (cleaned.includes(',') && !cleaned.includes('.')) {
      cleaned = cleaned.replace(',', '.');
    } else {
      cleaned = cleaned.replace(/,/g, '');
    }
    return cleaned.replace(/\s/g, '');
  };

  const formatValue = (input) => {
    const raw = parseCurrency(input.value);
    if (!raw) {
      input.value = '';
      return;
    }
    const number = Number(raw);
    if (!Number.isFinite(number)) return;
    input.value = formatter
      .format(number)
      .replace('MXN', '')
      .replace(/\u00a0/g, ' ')
      .trim();
  };

  currencyInputs.forEach(input => {
    if (input.value) {
      formatValue(input);
    }
    input.addEventListener('blur', () => formatValue(input));
    input.addEventListener('focus', () => {
      input.value = parseCurrency(input.value);
    });
  });
</script>
{% endblock %}
